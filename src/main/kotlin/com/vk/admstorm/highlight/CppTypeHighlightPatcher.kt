package com.vk.admstorm.highlight

import com.intellij.openapi.fileTypes.impl.AbstractFileType

/**
 * This object is needed to extend the lean standard C++ syntax highlighting.
 * It adds new keywords, types as well as built-in KPHP functionality.
 *
 * Colors mapping in default light theme:
 *
 * 1 - blue
 * 2 - purple
 * 3 - turquoise
 * 4 - red
 */
object CppTypeHighlightPatcher {
    private var patched = false

    // 1
    private val additionalKeywords = listOf("noexcept", "decltype", "final", "#pragma", "once", "forward")

    // 1
    private val basicTypes = listOf("mixed", "int64_t", "string", "tuple", "Unknown")

    // 1
    private val complexTypes = listOf("array", "Optional", "class_instance", "future", "future_queue", "regexp")

    // 2
    private val macros = listOf("TRY_CALL_VOID_", "TRY_CALL_", "SAFE_SET_OP")

    // 4
    private val builtinConstants = listOf(
        "v\$_SERVER",
        "v\$_GET",
        "v\$_POST",
        "v\$_FILES",
        "v\$_COOKIE",
        "v\$_REQUEST",
        "v\$_ENV",
        "v\$argc",
        "v\$argv",
        "tmp_var0",
        "tmp_var1",
        "tmp_var2",
        "tmp_var3",
        "tmp_var4",
        "tmp_var5",
        "tmp_strlen",
        "tmp_string",
    )

    // 3
    private val builtinFuncs = listOf(
        "append_unsafe",
        "finish_append",
        "assign",
        "get",
        "val",
        "get_value",
        "get_key",
        "set_value",
        "unset",
        "std",
        "create",
        "size_type",
        "max_string_size",
        "const_begin",
        "const_end",
        "make_tuple",
        "equals",
        "clear_array",
        "check_not_null",
        "check_not_false",
        "f\$print_r_",
        "f\$ob_clean",
        "f\$ob_end_clean",
        "f\$ob_get_clean",
        "f\$ob_get_contents",
        "f\$ob_start",
        "f\$ob_flush",
        "f\$ob_end_flush",
        "f\$ob_get_flush",
        "f\$ob_get_length",
        "f\$ob_get_level",
        "f\$header",
        "f\$headers_list",
        "f\$setcookie",
        "f\$setrawcookie",
        "f\$register_shutdown_function",
        "f\$error_get_last",
        "f\$error_reporting",
        "f\$warning",
        "f\$critical_error",
        "f\$exit",
        "f\$die",
        "f\$register_kphp_on_warning_callback",
        "f\$kphp_set_context_on_error",
        "f\$kphp_backtrace",
        "f\$ini_get",
        "f\$ini_set",
        "f\$memory_get_usage",
        "f\$memory_get_peak_usage",
        "f\$memory_get_total_usage",
        "f\$memory_get_static_usage",
        "f\$memory_get_detailed_stats",
        "f\$estimate_memory_usage",
        "f\$get_global_vars_memory_stats",
        "f\$get_net_time",
        "f\$get_script_time",
        "f\$get_net_queries_count",
        "f\$get_engine_uptime",
        "f\$get_engine_version",
        "f\$get_engine_workers_number",
        "f\$getKeyByPos",
        "f\$getValueByPos",
        "f\$create_vector",
        "f\$array_first_key",
        "f\$array_first_value",
        "f\$array_last_key",
        "f\$array_last_value",
        "f\$array_swap_int_keys",
        "f\$implode",
        "f\$explode",
        "f\$array_chunk",
        "f\$array_splice",
        "f\$array_merge",
        "f\$array_merge_into",
        "f\$array_merge_spread",
        "f\$array_replace",
        "f\$array_intersect_key",
        "f\$array_intersect",
        "f\$array_intersect_assoc",
        "f\$array_diff_key",
        "f\$array_diff",
        "f\$array_diff_assoc",
        "f\$array_reverse",
        "f\$array_shift",
        "f\$array_unshift",
        "f\$array_key_exists",
        "f\$array_search",
        "f\$array_find",
        "f\$array_rand",
        "f\$array_keys",
        "f\$array_keys_as_strings",
        "f\$array_keys_as_ints",
        "f\$array_values",
        "f\$array_unique",
        "f\$array_count_values",
        "f\$array_flip",
        "f\$in_array",
        "f\$array_fill",
        "f\$array_fill_keys",
        "f\$array_combine",
        "f\$range",
        "f\$array_push",
        "f\$array_pop",
        "f\$array_sum",
        "f\$array_slice",
        "f\$array_pad",
        "f\$array_column",
        "f\$min",
        "f\$max",
        "f\$array_filter",
        "f\$array_filter_by_key",
        "f\$array_map",
        "f\$array_reduce",
        "f\$array_reserve",
        "f\$array_reserve_vector",
        "f\$array_reserve_map_int_keys",
        "f\$array_reserve_map_string_keys",
        "f\$array_reserve_from",
        "f\$array_is_vector",
        "f\$empty",
        "f\$count",
        "f\$sizeof",
        "f\$gettype",
        "f\$is_scalar",
        "f\$is_numeric",
        "f\$is_null",
        "f\$is_bool",
        "f\$is_int",
        "f\$is_integer",
        "f\$is_long",
        "f\$is_finite",
        "f\$is_infinite",
        "f\$is_nan",
        "f\$is_float",
        "f\$is_double",
        "f\$is_real",
        "f\$is_string",
        "f\$is_array",
        "f\$is_object",
        "f\$get_class",
        "f\$get_hash_of_class",
        "f\$print_r",
        "f\$var_export",
        "f\$print",
        "f\$echo",
        "f\$dbg_echo",
        "f\$var_dump",
        "f\$checkdate",
        "f\$date",
        "f\$date_default_timezone_set",
        "f\$date_default_timezone_get",
        "f\$getdate",
        "f\$gmdate",
        "f\$gmmktime",
        "f\$localtime",
        "f\$microtime",
        "f\$mktime",
        "f\$strftime",
        "f\$strtotime",
        "f\$time",
        "f\$hrtime",
        "f\$debug_backtrace",
        "f\$posix_getpid",
        "f\$posix_getuid",
        "f\$posix_getpwuid",
        "f\$getopt",
        "f\$gethostbynamel",
        "f\$inet_pton",
        "f\$pack",
        "f\$unpack",
        "f\$serialize",
        "f\$unserialize",
        "f\$json_encode",
        "f\$json_decode",
        "f\$msgpack_serialize",
        "f\$msgpack_deserialize",
        "f\$msgpack_serialize_safe",
        "f\$msgpack_deserialize_safe",
        "f\$preg_match",
        "f\$preg_match_all",
        "f\$preg_replace",
        "f\$preg_replace_callback",
        "f\$preg_quote",
        "f\$preg_last_error",
        "f\$preg_split",
        "f\$shuffle",
        "f\$sort",
        "f\$rsort",
        "f\$usort",
        "f\$asort",
        "f\$arsort",
        "f\$uasort",
        "f\$ksort",
        "f\$krsort",
        "f\$uksort",
        "f\$natsort",
        "f\$lcg_value",
        "f\$uniqid",
        "f\$srand",
        "f\$rand",
        "f\$getrandmax",
        "f\$mt_srand",
        "f\$mt_rand",
        "f\$mt_getrandmax",
        "f\$hash_algos",
        "f\$hash_hmac_algos",
        "f\$hash",
        "f\$hash_hmac",
        "f\$sha1",
        "f\$md5",
        "f\$md5_file",
        "f\$crc32",
        "f\$crc32_file",
        "f\$hash_equals",
        "f\$cp1251",
        "f\$openssl_public_encrypt",
        "f\$openssl_private_decrypt",
        "f\$openssl_pkey_get_private",
        "f\$openssl_pkey_get_public",
        "f\$openssl_sign",
        "f\$openssl_verify",
        "f\$openssl_random_pseudo_bytes",
        "f\$openssl_x509_parse",
        "f\$openssl_x509_checkpurpose",
        "f\$openssl_pkcs7_sign",
        "f\$openssl_get_cipher_methods",
        "f\$openssl_cipher_iv_length",
        "f\$openssl_encrypt",
        "f\$openssl_decrypt",
        "f\$gzencode",
        "f\$gzdecode",
        "f\$gzcompress",
        "f\$gzuncompress",
        "f\$gzdeflate",
        "f\$gzinflate",
        "f\$base64_decode",
        "f\$base64_encode",
        "f\$http_build_query",
        "f\$rawurldecode",
        "f\$rawurlencode",
        "f\$urldecode",
        "f\$urlencode",
        "f\$parse_url",
        "f\$abs",
        "f\$acos",
        "f\$acosh",
        "f\$asin",
        "f\$asinh",
        "f\$atan",
        "f\$atan2",
        "f\$base_convert",
        "f\$ceil",
        "f\$cos",
        "f\$cosh",
        "f\$deg2rad",
        "f\$exp",
        "f\$floor",
        "f\$log",
        "f\$fmod",
        "f\$pi",
        "f\$round",
        "f\$sin",
        "f\$sinh",
        "f\$sqrt",
        "f\$tan",
        "f\$rad2deg",
        "f\$addcslashes",
        "f\$addslashes",
        "f\$bindec",
        "f\$bin2hex",
        "f\$chr",
        "f\$convert_cyr_string",
        "f\$count_chars",
        "f\$decbin",
        "f\$dechex",
        "f\$hex2bin",
        "f\$hexdec",
        "f\$htmlentities",
        "f\$html_entity_decode",
        "f\$htmlspecialchars",
        "f\$htmlspecialchars_decode",
        "f\$levenshtein",
        "f\$mysql_escape_string",
        "f\$nl2br",
        "f\$number_format",
        "f\$parse_str",
        "f\$ord",
        "f\$strcasecmp",
        "f\$strcmp",
        "f\$stripslashes",
        "f\$strip_tags",
        "f\$strncmp",
        "f\$strnatcmp",
        "f\$wordwrap",
        "f\$ip2long",
        "f\$ip2ulong",
        "f\$long2ip",
        "f\$get_magic_quotes_gpc",
        "f\$php_sapi_name",
        "f\$str_pad",
        "f\$str_repeat",
        "f\$lcfirst",
        "f\$ucfirst",
        "f\$ucwords",
        "f\$vprintf",
        "f\$printf",
        "f\$vsprintf",
        "f\$sprintf",
        "f\$vfprintf",
        "f\$fprintf",
        "f\$fputcsv",
        "f\$fgetcsv",
        "f\$strtr",
        "f\$str_replace",
        "f\$str_ireplace",
        "f\$str_split",
        "f\$strlen",
        "f\$strpbrk",
        "f\$strpos",
        "f\$stripos",
        "f\$strrpos",
        "f\$strripos",
        "f\$strstr",
        "f\$stristr",
        "f\$strrchr",
        "f\$strrev",
        "f\$strtolower",
        "f\$strtoupper",
        "f\$substr",
        "f\$substr_count",
        "f\$substr_replace",
        "f\$substr_compare",
        "f\$trim",
        "f\$ltrim",
        "f\$rtrim",
        "f\$xor_strings",
        "f\$similar_text",
        "f\$setlocale",
        "f\$iconv",
        "f\$mb_check_encoding",
        "f\$mb_strlen",
        "f\$mb_strpos",
        "f\$mb_stripos",
        "f\$mb_strtolower",
        "f\$mb_strtoupper",
        "f\$mb_substr",
        "f\$bcscale",
        "f\$bcdiv",
        "f\$bcmod",
        "f\$bcpow",
        "f\$bcadd",
        "f\$bcsub",
        "f\$bcmul",
        "f\$bccomp",
        "f\$mysqli_errno",
        "f\$mysqli_error",
        "f\$mysqli_affected_rows",
        "f\$mysqli_fetch_array",
        "f\$mysqli_insert_id",
        "f\$mysqli_num_rows",
        "f\$mysqli_query",
        "f\$mysqli_connect",
        "f\$mysqli_select_db",
        "f\$function_exists",
        "f\$basename",
        "f\$chmod",
        "f\$clearstatcache",
        "f\$copy",
        "f\$dirname",
        "f\$file",
        "f\$file_get_contents",
        "f\$file_put_contents",
        "f\$file_exists",
        "f\$filesize",
        "f\$filectime",
        "f\$filemtime",
        "f\$is_dir",
        "f\$is_file",
        "f\$is_readable",
        "f\$is_writeable",
        "f\$mkdir",
        "f\$php_uname",
        "f\$rename",
        "f\$realpath",
        "f\$tempnam",
        "f\$unlink",
        "f\$scandir",
        "f\$sleep",
        "f\$usleep",
        "f\$getimagesize",
        "f\$vk_utf8_to_win",
        "f\$vk_win_to_utf8",
        "f\$vk_flex",
        "f\$vk_json_encode",
        "f\$vk_json_encode_safe",
        "f\$vk_whitespace_pack",
        "f\$vk_sp_simplify",
        "f\$vk_sp_full_simplify",
        "f\$vk_sp_deunicode",
        "f\$vk_sp_to_upper",
        "f\$vk_sp_to_lower",
        "f\$vk_sp_to_sort",
        "f\$vk_sp_remove_repeats",
        "f\$vk_sp_to_cyrillic",
        "f\$vk_sp_words_only",
        "f\$vk_stats_hll_merge",
        "f\$vk_stats_hll_count",
        "f\$vk_stats_hll_create",
        "f\$vk_stats_hll_add",
        "f\$vk_stats_hll_pack",
        "f\$vk_stats_hll_unpack",
        "f\$vk_stats_hll_is_packed",
        "f\$vk_dot_product",
        "f\$likely",
        "f\$unlikely",
        "f\$err",
        "f\$fetch_int",
        "f\$fetch_long",
        "f\$fetch_double",
        "f\$fetch_float",
        "f\$fetch_string",
        "f\$fetch_string_as_int",
        "f\$fetch_memcache_value",
        "f\$fetch_eof",
        "f\$fetch_end",
        "f\$fetch_lookup_int",
        "f\$fetch_lookup_data",
        "f\$rpc_parsefinal",
        "f\$new_rpc_connection",
        "f\$store_gzip_pack_threshold",
        "f\$store_start_gzip_pack",
        "f\$store_finish_gzip_pack",
        "f\$rpc_clean",
        "f\$store_header",
        "f\$store_error",
        "f\$store_raw",
        "f\$set_fail_rpc_on_int32_overflow",
        "f\$store_int",
        "f\$store_long",
        "f\$store_double",
        "f\$store_float",
        "f\$store_string",
        "f\$store_many",
        "f\$store_finish",
        "f\$rpc_send",
        "f\$rpc_send_noflush",
        "f\$rpc_flush",
        "f\$rpc_get",
        "f\$rpc_get_synchronously",
        "f\$rpc_get_and_parse",
        "f\$rpc_queue_create",
        "f\$rpc_queue_push",
        "f\$rpc_queue_empty",
        "f\$rpc_queue_next",
        "f\$rpc_queue_next_synchronously",
        "f\$rpc_wait",
        "f\$rpc_wait_concurrently",
        "f\$rpc_mc_parse_raw_wildcard_with_flags_to_array",
        "f\$rpc_tl_query_one",
        "f\$rpc_tl_query",
        "f\$rpc_tl_query_result_one",
        "f\$rpc_tl_query_result",
        "f\$rpc_tl_query_result_synchronously",
        "f\$rpc_tl_pending_queries_count",
        "f\$typed_rpc_tl_query_one",
        "f\$typed_rpc_tl_query",
        "f\$typed_rpc_tl_query_result_one",
        "f\$typed_rpc_tl_query_result",
        "f\$typed_rpc_tl_query_result_synchronously",
        "f\$rpc_server_fetch_request",
        "f\$rpc_server_store_response",
        "f\$wait",
        "f\$wait_multi",
        "f\$wait_synchronously",
        "f\$wait_concurrently",
        "f\$wait_queue_create",
        "f\$wait_queue_push",
        "f\$wait_queue_empty",
        "f\$wait_queue_next",
        "f\$wait_queue_next_synchronously",
        "f\$sched_yield",
        "f\$sched_yield_sleep",
        "f\$get_running_fork_id",
        "f\$get_fork_stat",
        "f\$query_x2",
        "f\$set_wait_all_forks_on_finish",
        "f\$arrayval",
        "f\$boolval",
        "f\$intval",
        "f\$floatval",
        "f\$strval",
        "f\$fopen",
        "f\$fwrite",
        "f\$fseek",
        "f\$rewind",
        "f\$ftell",
        "f\$fread",
        "f\$fgetc",
        "f\$fgets",
        "f\$fpassthru",
        "f\$fflush",
        "f\$feof",
        "f\$fclose",
        "f\$stream_context_create",
        "f\$stream_context_set_option",
        "f\$stream_socket_client",
        "f\$stream_set_blocking",
        "f\$stream_set_write_buffer",
        "f\$stream_set_read_buffer",
        "f\$stream_select",
        "f\$is_uploaded_file",
        "f\$move_uploaded_file",
        "f\$mail",
        "f\$curl_init",
        "f\$curl_reset",
        "f\$curl_setopt",
        "f\$curl_setopt_array",
        "f\$curl_exec",
        "f\$curl_getinfo",
        "f\$curl_error",
        "f\$curl_errno",
        "f\$curl_close",
        "f\$curl_multi_init",
        "f\$curl_multi_add_handle",
        "f\$curl_multi_getcontent",
        "f\$curl_multi_setopt",
        "f\$curl_multi_exec",
        "f\$curl_multi_select",
        "f\$curl_multi_info_read",
        "f\$curl_multi_remove_handle",
        "f\$curl_multi_errno",
        "f\$curl_multi_close",
        "f\$curl_multi_strerror",
        "f\$get_reference_counter",
        "f\$prepare_search_query",
        "f\$system",
        "f\$raise_sigsegv",
        "f\$make_clone",
        "f\$instance_cast",
        "f\$instance_to_array",
        "f\$instance_cache_fetch",
        "f\$instance_cache_store",
        "f\$instance_cache_update_ttl",
        "f\$instance_cache_delete",
        "f\$instance_serialize",
        "f\$instance_deserialize",
        "f\$is_confdata_loaded",
        "f\$confdata_get_value",
        "f\$confdata_get_values_by_any_wildcard",
        "f\$confdata_get_values_by_pre",
        "f\$profiler_set_log_suffix",
        "f\$profiler_set_function_label",
        "f\$profiler_is_enabled",
        "f\$kphp_job_worker_start",
        "f\$kphp_job_worker_start_no_reply",
        "f\$kphp_job_worker_start_multi",
        "f\$kphp_job_worker_fetch_request",
        "f\$kphp_job_worker_store_response",
        "f\$is_kphp_job_workers_enabled",
        "f\$get_job_workers_number",
        "f\$zstd_compress",
        "f\$zstd_uncompress",
        "f\$zstd_compress_dict",
        "f\$zstd_uncompress_dict",
        "f\$set_migration_php8_warning",
        "f\$set_json_log_on_timeout_mode",
    )

    /**
     * Adds new highlighting tokens to the passed abstract type for C/C++.
     */
    fun patch(type: AbstractFileType) {
        if (patched) {
            return
        }

        additionalKeywords.forEach {
            type.syntaxTable.addKeyword1(it)
        }

        basicTypes.forEach {
            type.syntaxTable.addKeyword1(it)
        }

        complexTypes.forEach {
            type.syntaxTable.addKeyword1(it)
        }

        macros.forEach {
            type.syntaxTable.addKeyword2(it)
        }

        builtinFuncs.forEach {
            type.syntaxTable.addKeyword3(it)
        }

        builtinConstants.forEach {
            type.syntaxTable.addKeyword4(it)
        }

        patched = true
    }
}
